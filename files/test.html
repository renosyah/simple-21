<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>
       Simple-21-test
    </title>

    <!-- CSS  -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="./css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link href="./css/custom.css" type="text/css" rel="stylesheet" media="screen,projection" />
    
</head>

<body>
    <noscript>
      <strong>We're sorry but Simple-21 doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
    </noscript>  
    <div id="app"> 

        <div id="bg" v-show="page_name != 'loading-page'"></div>
        <div class="valign-wrapper" style="width:100%;height:100%;position: absolute;">
            <div class="valign" style="width:100%;">
                <div class="container">
                   <div class="row">
                      <div class="col s12 m6 offset-m3">

                        <div class="card">
                            <div class="card-title">
                                <h3 class="center green-text">
                                    <br />
                                    Testing Websocket
                                </h3>
                            </div>
                            <div class="card-image">
                            </div>
                            <div class="card-content">
                                <ul class="collection" v-for="(message,index) in messages" v-bind:key="index">
                                    <li class="collection-item avatar">
                                        <i class="material-icons circle green">account_circle</i>
                                        <span class="title">{{ message }}</span>
                                      </li>
                                   </ul>

                                <div class="input-field">
                                    <input id="simple-text" type="text" class="validate" v-model="message.data">
                                    <label for="simple-text">
                                        Message
                                    </label>
                                </div>
                            </div>
                            <div class="center card-action">
                                <a class="container waves-effect waves-light btn-large btn green white-text" style="text-transform:none" @click="reJoin">
                                    <b>
                                        ReJoin
                                    </b>    
                                </a>
                            </div>
                          </div>

                      </div>
                   </div>
                </div>
            </div>
        </div>

    </div>
    <!-- built files will be auto injected -->

    <!--  Scripts-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="./js/materialize.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>

        new Vue({
            el: '#app',
            data() {
                return {
                    player : {
                        id : "",
                        name : "",
                        money : ""
                    },
                    ws : null,
                    message : {
                        name : "",
                        data : "",
                    },
                    messages : [],          
                    page_name : "main-page",
                    is_online : true,
                    is_loading : false,
                    host : {
                        name : "",
                        protocol : "",
                        port : ""
                    },
                    localize : {
                        choosed : "ind",
                        list : [{
                            label :"Indonesia" ,
                            value :"ind" 
                        },{
                            label :"English" ,
                            value :"en" 
                        }]
                    }
                }
            },
            created(){
                window.addEventListener('offline', () => { this.is_online = false })
                window.addEventListener('online', () => { this.is_online = true })
                window.history.pushState({ noBackExitsApp: true }, '')
                window.addEventListener('popstate', this.backPress )
                this.setCurrentHost()

                this.ws = new WebSocket("ws://" + this.host.name + ":" + this.host.port + "/wslobby")
                this.ws.onmessage = this.wsOnmessage
                this.ws.onopen = this.wsOpen
                this.ws.onclose = this.onclose
            },
            mounted () {
                window.$('.dropdown-trigger').dropdown()
                window.$('.modal').modal()
                this.initPlayer()
            },
            methods : {

                initPlayer(){

                    let param = new URLSearchParams(window.location.search)
                    if (!param.get('player-id')){
                        return
                    }

                    this.is_loading = true

                    axios.post(this.baseUrl() + "player", JSON.stringify({id : param.get('player-id')}))
                        .then(response => {

                            this.is_loading = false
                            if (response.data.status == 404) {
                                window.location = this.baseUrl() + "test.html"
                                return
                            }
                            this.player = response.data.result

                        })
                        .catch(e => {
                            console.log(e)
                            this.is_loading = false
                        })

                },
                switchPage(name){
                    this.page_name = name
                },
                backPress(){
                    if (event.state && event.state.noBackExitsApp) {
                        window.history.pushState({ noBackExitsApp: true }, '')
                    }
                },
                localizeCheck(lang){ 
                    return this.localize.choosed == lang 
                },
                setCurrentHost(){
                    this.host.name = window.location.hostname
                    this.host.port = location.port
                    this.host.protocol = location.protocol.concat("//")
                },
                baseUrl(){
                    return this.host.protocol.concat(this.host.name + ":" + this.host.port + "/")
                },
                reJoin(){
                    this.ws.send(JSON.stringify({
                        name : "LOBBY_EVENT_PLAYER_REJOIN",
                        data : this.player,
                    }))
                },
                wsOpen(){

                },
                wsClose(){

                },
                wsOnmessage(evt){
                    this.messages.push(JSON.parse(evt.data))
                }
            }
        })

    </script>
</body>

</html>