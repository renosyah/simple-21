<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>
       Simple-21
    </title>

    <!-- CSS  -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="./css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link href="./css/custom.css" type="text/css" rel="stylesheet" media="screen,projection" />
</head>

<body>
    <noscript>
      <strong>We're sorry but Simple-21 doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
    </noscript>  
    <div id="app"> 

        <div id="bg"></div>
        
        <!---------OFFLINE WARNING---------->
        <div class="offline-warning">
            <transition name="bounce">
                <div class="container center" v-show="!is_online" v-on:click="is_online = true">
                    <div class="row">
                        <div class="col s12 m2"></div>
                        <div class="col s12 m8">
                            <div class="chip red white-text center">
                                <span class="white-text" v-show="localizeCheck('ind')">Perangkat Anda Sedang Offline!</span>
                                <span class="white-text" v-show="localizeCheck('en')">Your Device is Offline!</span>
                            </div>
                        </div>
                        <div class="col s12 m2"></div>
                    </div>
                </div>
            </transition>
        </div>


        <!---------LOADING---------->
        <div class="preloader-background" v-show="is_loading">
            
            <div class="valign-wrapper" style="width:100%;height:100%;position: absolute;">
                <div class="valign" style="width:100%;">
                    <div class="container">
                        <div class="row">
                            <div class="center col s12 m6 offset-m3">
                            <div class="preloader-wrapper big active">
                                <div class="spinner-layer spinner-green-only">
                                    <div class="circle-clipper left">
                                    <div class="circle"></div>
                                    </div><div class="gap-patch">
                                    <div class="circle"></div>
                                    </div><div class="circle-clipper right">
                                    <div class="circle"></div>
                                    </div>
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!---------SIGN IN PAGE---------->
        <div v-show="getPageName == 'login-page'">

            <div class="valign-wrapper" style="width:100%;height:100%;position: absolute;">
                <div class="valign" style="width:100%;">
                    <div class="container">
                       <div class="row">
                          <div class="col s12 m8 l6 offset-m2 offset-l3">

                            <div class="card">
                                <div class="card-title">
                                    <h5 class="center green-text">
                                        <br />
                                        <span v-show="localizeCheck('ind')">Selamat datang!</span>
                                        <span v-show="localizeCheck('en')">Welcome!</span>
                                    </h5>
                                </div>
                                <div class="card-image">
                                </div>
                                <div class="card-content">
                                    <div class="input-field">
                                        <input id="fullname" type="text" class="validate" v-model="player.name">
                                        <label for="fullname">
                                            <span v-show="localizeCheck('ind')">Nama Pemain</span>
                                            <span v-show="localizeCheck('en')">Player Name</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="center card-action">
                                    <a class="waves-effect waves-light btn-large btn green white-text" style="text-transform:none;width: 100%;" @click="addPlayer">
                                        <b>
                                            <span v-show="localizeCheck('ind')">Masuk</span>
                                            <span v-show="localizeCheck('en')">Enter</span>
                                        </b>    
                                    </a>
                                </div>
                              </div>
                          </div>
                       </div>
                    </div>
                </div>
            </div>
        </div>
        <!---------DASHBOARD PAGE---------->
        <div v-show="getPageName == 'main-page'">

            <div class="container">
                <div class="row">
                    <div class="col s12 m12 l12"> 
                        <div class="card-panel white">                     
                            <ul class="collection">
                                <li class="collection-item avatar">
                                    <i class="material-icons circle green">account_circle</i>
                                    <span class="title">{{ player.name }}</span>
                                    <p> $ {{ player.money }}</p>
                                </li>
                            </ul>
                            <div class="row">
                                <div class="center col s6 s6 l6">
                                    <br />
                                    <a class="col s12 waves-effect waves-light btn-large green white-text">
                                        <span v-show="localizeCheck('ind')">Buat Ruangan</span>
                                        <span v-show="localizeCheck('en')">Create Room</span>
                                    </a>
                                    
                                </div>
                                <div class="center col s6 s6 l6">
                                    <br />
                                    <a class="col s12 waves-effect waves-light btn-large grey white-text" @click="exit">
                                        <span v-show="localizeCheck('ind')">Keluar</span>
                                        <span v-show="localizeCheck('en')">Exit</span>
                                    </a>
                                    
                                </div> 
                            </div> 
                        </div>                        
                    </div>
                </div>        
                <div class="row">
                    <div class="col s12 m6 l4">
                        <div class="card-panel white">
                            <h6 class="green-text">
                                <span v-show="localizeCheck('ind')">Pemain ({{ players.length }})</span>
                                <span v-show="localizeCheck('en')">Players ({{ players.length }})</span>
                            </h6>
                            <p v-show="players.length <= 1">-                                         
                                <span v-show="localizeCheck('ind')">Tidak Ada Pemain Lain</span>
                                <span v-show="localizeCheck('en')">No Other Player Online</span> 
                            -</p>
                            <ul class="collection" v-for="p in players" v-bind:key="p.id" v-show="p.id != player.id">
                                <li class="collection-item avatar">
                                    <i class="material-icons circle green">account_circle</i>
                                    <span class="title">
                                        {{ p.name }} 
                                    </span>
                                    <p>$ {{ p.money }} <br>
                                    </p>
                                    <a class="secondary-content"><i :class="{'material-icons':true,'red-text':!p.is_online,'green-text':p.is_online}">{{ p.is_online ? "link" : "link_off" }}</i></a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="col s12 m6 l8">
                        <div class="card-panel white">
                            <h6 class="green-text">
                                <span v-show="localizeCheck('ind')">Ruang Bermain ({{ rooms.length }})</span>
                                <span v-show="localizeCheck('en')">Rooms ({{ rooms.length }})</span>
                            </h6>
                            <p v-show="rooms.length == 0">-                                         
                                <span v-show="localizeCheck('ind')">Tidak Ada Ruangan</span>
                                <span v-show="localizeCheck('en')">No Room</span> 
                            -</p>
                            <ul class="collection" v-for="(r,i) in rooms" v-bind:key="r.id">
                                <li class="collection-item avatar">
                                    <i class="material-icons circle green">group</i>
                                    <span class="title">
                                        <span v-show="localizeCheck('ind')">Ruangan</span>
                                        <span v-show="localizeCheck('en')">Room</span>
                                    {{ r.name }}</span>
                                    <p> </p>
                                    <a class="secondary-content"><i class="material-icons">arrow_forward</i></a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- built files will be auto injected -->

    <!--  Scripts-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="./js/materialize.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>

	// FOR BROADCASTER
	const LOBBY_EVENT_ROOM_CREATED = "LOBBY_EVENT_ROOM_CREATED"
	const LOBBY_EVENT_ROOM_REMOVE  = "LOBBY_EVENT_ROOM_REMOVED"

	// FOR BROADCASTER RECEIVER
	const LOBBY_EVENT_ON_JOIN         = "LOBBY_EVENT_ON_PLAYER_JOIN"
	const LOBBY_EVENT_ON_DISCONNECTED = "LOBBY_EVENT_ON_PLAYER_DISCONNECTED"
	const LOBBY_EVENT_ON_LOGOUT       = "LOBBY_EVENT_ON_PLAYER_LOGOUT"

    new Vue({
        el: '#app',
        data() {
            return {
                players : [],
                player : {
                    id : "",
                    name : "",
                    money : 0
                },
                rooms : [],
                room : {
                    id:"",
                    name : "",
                    players : [],
                },
                lobby_ws : null,
                is_online : true,
                is_loading : false,
                host : {
                    name : "",
                    protocol : "",
                    port : ""
                }
            }
        },
        created(){
            window.addEventListener('offline', () => { this.is_online = false })
            window.addEventListener('online', () => { this.is_online = true })
            window.history.pushState({ noBackExitsApp: true }, '')
            window.addEventListener('popstate', this.backPress )
            this.setCurrentHost()
        },
        mounted () {
            window.$('.dropdown-trigger').dropdown()
            window.$('.modal').modal()
            this.initPlayer()
            
        },
        computed : {
            getPageName(){
                let param = new URLSearchParams(window.location.search)
                let name = param.get('page')
                return name ? name : "login-page"
            },
        },
        methods : {
            addPlayer(){
                this.is_loading = true
                axios.post(this.baseUrl() + "addplayer", JSON.stringify(this.player))
                    .then(response => {
                        this.is_loading = false
                        if (response.data.status == 507) {
                            window.M.toast({html: '<b>Server is Full!</b>', classes: 'white green-text'})
                            return
                        }
                        this.player = response.data.result
                        if ('URLSearchParams' in window) {
                            var searchParams = new URLSearchParams(window.location.search);
                            searchParams.set('page','main-page');
                            searchParams.set('player-id',this.player.id);
                            window.location.search = searchParams.toString();
                        }
                    })
                    .catch(e => {
                        console.log(e)
                        this.is_loading = false
                    })
            },
            initPlayer(){
                let param = new URLSearchParams(window.location.search)
                if (!param.get('player-id')){
                    return
                }
                this.is_loading = true
                axios.post(this.baseUrl() + "player", JSON.stringify({id : param.get('player-id')}))
                    .then(response => {
                        this.is_loading = false
                        if (response.data.status == 404) {
                            window.location = this.baseUrl()
                            return
                        }
                        this.player = response.data.result
                        this.initLobbyWs()
                    })
                    .catch(e => {
                        console.log(e)
                        this.is_loading = false
                    })
            },
            getPlayers(){
                axios.get(this.baseUrl() + "players")
                    .then(response => {
                        this.players = response.data.result
                    })
                    .catch(e => {
                        console.log(e)
                    })
            },
            exit(){
                this.lobby_ws.close()
                this.is_loading = true
                axios.post(this.baseUrl() + "delplayer", JSON.stringify(this.player))
                    .then(response => {
                        this.is_loading = false
                        this.player = response.data.result
                        window.location = this.baseUrl()
                    })
                    .catch(e => {
                        console.log(e)
                        this.is_loading = false
                    })
            },
            getRooms(){
                axios.get(this.baseUrl() + "rooms")
                    .then(response => {
                        this.rooms = response.data.result
                    })
                    .catch(e => {
                        console.log(e)
                    })
            },
            initLobbyWs(){
                this.lobby_ws = new WebSocket("ws://" + this.host.name + ":" + this.host.port + "/ws-lobby?id-player=" + this.player.id)
                this.lobby_ws.onmessage = (evt) => {
                    let event = JSON.parse(evt.data)
                    switch (event.name) {
                        case LOBBY_EVENT_ON_JOIN: case LOBBY_EVENT_ON_LOGOUT: case LOBBY_EVENT_ON_DISCONNECTED:
                            this.getPlayers()
                            break;
                        case LOBBY_EVENT_ROOM_CREATED: case LOBBY_EVENT_ROOM_REMOVE:
                            this.getRooms()
                            break;
                        default: break;
                    }
                }
                this.getPlayers()
                this.getRooms()
            },
            switchPage(name){
                if ('URLSearchParams' in window) {
                    var searchParams = new URLSearchParams(window.location.search);
                    searchParams.set('page', name);
                    window.location.search = searchParams.toString();
                }
            },
            switchLocalize(lang){
                if ('URLSearchParams' in window) {
                    var searchParams = new URLSearchParams(window.location.search);
                    searchParams.set('loc', name);
                    window.location.search = searchParams.toString();
                }
            },
            localizeCheck(lang){
                let def = "ind"
                let param = new URLSearchParams(window.location.search)
                let name = param.get('loc')
                return name ? (name == lang) : (def == lang)
            },
            backPress(){
                if (event.state && event.state.noBackExitsApp) {
                    window.history.pushState({ noBackExitsApp: true }, '')
                }
            },
            setCurrentHost(){
                this.host.name = window.location.hostname
                this.host.port = location.port
                this.host.protocol = location.protocol.concat("//")
            },
            baseUrl(){
                return this.host.protocol.concat(this.host.name + ":" + this.host.port + "/")
            },
        }
    })


    </script>
</body>

</html>